name: vulncheck

on:
  push:
    branches:
      - main

jobs:
  build:
    name: Building
    runs-on: ubuntu-latest
    steps:
      - run: echo "COMPILACIÃ“N DE APLICATIVO"

  test:
    name: Testing
    runs-on: ubuntu-latest
    needs: build
    steps:
      - run: echo "PRUEBAS EN APLICATIVO"

  sca:
    name: Software Composition Analysis
    runs-on: ubuntu-latest
    needs: test
    steps:
      - uses: actions/checkout@v2
          
      - name: Run Snyk Test (Dependencies)
        uses: snyk/actions/node@master
        continue-on-error: true
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          command: test
          args: --file=CODE/package.json --json-file-output=snyk-dependencies.json --severity-threshold=low
            
      - name: Upload SCA Results
        uses: actions/upload-artifact@v4
        with:
          name: SCA-Results
          path: snyk-dependencies.json
        if: always()

  secret_scanning:
    name: Secret Scanning
    runs-on: ubuntu-latest
    needs: test
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0
    
      - name: Run TruffleHog
        run: |
          docker run --rm \
            -v $(pwd):/src \
            trufflesecurity/trufflehog:latest \
            filesystem /src/CODE \
            --json \
            --no-update \
            --fail > trufflehog-output.json || true
        continue-on-error: true

      - name: Upload Secret Scanning Results
        uses: actions/upload-artifact@v4
        with:
          name: Secret-Scanning-Results
          path: trufflehog-output.json
        if: always()

  sast:
    name: Static Testing (SAST)
    runs-on: ubuntu-latest
    needs: [sca, secret_scanning]
    steps:
      - uses: actions/checkout@v3
      
      - name: Run Snyk Code (Source Code Analysis)
        uses: snyk/actions/node@master
        continue-on-error: true
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          command: code test
          args: CODE/ --json-file-output=snyk-code-analysis.json

      - name: Run Semgrep
        run: |
          docker run --rm \
            -v $(pwd)/CODE:/src \
            -v $(pwd):/output \
            returntocorp/semgrep \
            semgrep scan /src \
            --config=auto \
            --json \
            --output=/output/semgrep-results.json || true
        continue-on-error: true

      - name: List generated files
        run: |
          echo "=== Archivos SAST generados ==="
          ls -lh *.json 2>/dev/null || echo "No se encontraron archivos"
      
      - name: Upload SAST Results
        uses: actions/upload-artifact@v4
        with:
          name: SAST-Results
          path: |
            snyk-code-analysis.json
            semgrep-results.json
        if: always()

  dast:
    name: Dynamic Testing (DAST)
    runs-on: ubuntu-latest
    needs: sast
    steps:
      - uses: actions/checkout@v4

      - name: Run OWASP ZAP Baseline Scan
        uses: zaproxy/action-baseline@v0.7.0
        with:
          target: "http://98.80.216.157:3000/"   #CAMBIA ESTA URL
          rules_file_name: ".zap/rules.tsv"
          cmd_options: "-a"

      - name: Upload DAST Results
        uses: actions/upload-artifact@v4
        with:
          name: DAST-Results
          path: zap_report.html
        if: always()
